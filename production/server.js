const express=require("express"),app=express(),server=require("http").createServer(app),serveIndex=require("serve-index"),cookieParser=require("cookie-parser"),bodyParser=require("body-parser"),jwt=require("jsonwebtoken"),Game=require("./game/game.js"),game=new Game,Log=require("./logger")(process.argv),db=require("./database.js")(process.argv);require("./sockets.js")(server,db,Log,game);const port=3e3;app.use(cookieParser()),app.use(bodyParser.json()),app.use(bodyParser.urlencoded({extended:!0}));let colors=["#40A346","#406CA3","#C75FC2","#D10F0F"];const chosenColors=[],randomColor=()=>{0===colors.length&&(colors=chosenColors.slice());const color=colors.splice(Math.floor(Math.random()*colors.length),1);return chosenColors.push(color),color};app.use(express.static("public")),app.use("/logs",express.static("logs")),app.use("/logs",serveIndex("logs",{stylesheet:`${__dirname}/public/css/logs.css`,icons:!0})),app.get(["/","/enter.html"],(req,res)=>{const userIP=req.headers["x-forwarded-for"]||req.connection.remoteAddress,oldToken=req.cookies.superEvilVirus;oldToken?db.User.findOne({token:oldToken},(err,found)=>{found?(found.ip=userIP,found.state="Connecting...",found.save(),Log.server({action:"reconnect",agent:found.nickname}),res.redirect("game.html")):(Log.server("Couldn't find user",{action:"reconnect",agent:userIP}),res.clearCookie("superEvilVirus"),res.redirect("enter.html"))}):(Log.server({action:"connect",agent:userIP}),res.redirect("enter.html"))}),app.post("/enter.html",(req,res)=>{const userIP=req.headers["x-forwarded-for"]||req.connection.remoteAddress;jwt.sign({nickname:req.body.nickname},db.config.secret,{expiresIn:"8h"},(err,newToken)=>{new db.User({color:randomColor(),ip:userIP,mode:"unassigned",nickname:req.body.nickname,state:"Connecting...",token:newToken}).save(),res.cookie("superEvilVirus",newToken),res.redirect("game.html")})}),server.listen(3e3,()=>{Log.server({action:"start"})});