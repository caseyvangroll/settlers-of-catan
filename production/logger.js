const fs=require("fs"),winston=require("winston"),geoip=require("geoip-lite"),countrynames=require("countrynames");let buildNumber="Unknown";try{buildNumber=fs.readFileSync("current_build.txt","utf8").toString().replace(/\D/g,"")}catch(err){}const timestamp=()=>{const datetime=new Date;return`${datetime.getMonth()+1}/${datetime.getDate()} ${datetime.toLocaleTimeString()} `},lookup=ip=>{const result=geoip.lookup(ip);return result?`${result.city?`${result.city}, `:""}${result.region?`${result.region}, `:""}${countrynames.getName(result.country)}`:"Unknown"},format=(transport,level,meta,body)=>{let result=timestamp();switch(meta.action){case"bind":result+=`[    Bind    ] <${meta.agent}> = ${body}`;break;case"connect":result+=`[   Connect  ] <${meta.agent}> ${lookup(meta.agent)}`;break;case"disconnect":result+=`[ Disconnect ] <${meta.agent}>`;break;case"error":result+=`<<< ERROR >>>  <${meta.agent||"Unknown"}> ${body}`;break;case"reconnect":result+=`[  Reconnect ] <${meta.agent}> ${body||""}`;break;case"start":result+="[    Start   ]";break;default:result+=`- ${body}`}return"console"===transport?winston.config.colorize(level,result):result},logger=new winston.Logger({transports:[new winston.transports.Console({json:!1,showLevel:!1,colorize:!0,level:"debug",formatter:options=>format("console",options.level,options.meta,options.message)}),new winston.transports.File({filename:`logs/Build-${buildNumber}.log`,json:!1,showLevel:!1,level:"server",formatter:options=>format("file",options.level,options.meta,options.message)})],levels:{error:0,game:1,chat:1,server:2,debug:3},colors:{error:"red",game:"green",chat:"white",server:"cyan",debug:"grey"}});module.exports=(args=>(args.includes("test")?(logger.remove(winston.transports.File),fs.existsSync("logs/Build-Unknown.log")&&fs.unlink("logs/Build-Unknown.log"),args.includes("quiet")&&logger.remove(winston.transports.Console)):fs.existsSync("logs")||fs.mkdirSync("logs"),logger));