const fs=require("fs"),winston=require("winston"),geoip=require("geoip-lite"),countrynames=require("countrynames");let buildNumber="Unknown";try{buildNumber=fs.readFileSync("current_build.txt","utf8").toString().replace(/\D/g,"")}catch(err){}const timestamp=()=>{const datetime=new Date;return`${datetime.getMonth()+1}/${datetime.getDate()} ${datetime.toLocaleTimeString()} `},lookup=ip=>{const result=geoip.lookup(ip);return result?`${result.city?`${result.city}, `:""}${result.region?`${result.region}, `:""}${countrynames.getName(result.country)}`:"Unknown"},format=(transport,level,meta,body)=>{let result=timestamp();switch(meta.action){case"bind":result+=`[    Bind    ] <${meta.agent}> = ${body} (${meta.mode})`;break;case"connect":result+=`[   Connect  ] <${meta.agent}> ${lookup(meta.agent)}`;break;case"disconnect":result+=`[ Disconnect ] <${meta.agent}>`;break;case"error":result+=`<<< ERROR >>>  <${meta.agent||"Unknown"}> ${body}`;break;case"reconnect":result+=`[  Reconnect ] <${meta.agent}> ${body||""}`;break;case"start":result+="[    Start   ]";break;default:result+=`- ${body}`}return"console"===transport?winston.config.colorize(level,result):result},consoleTransports=new winston.transports.Console({json:!1,showLevel:!1,colorize:!0,level:"server",name:"console",formatter:options=>format("console",options.level,options.meta,options.message)}),fileTransports=[new winston.transports.File({filename:`logs/Build-${buildNumber}/game.log`,json:!1,showLevel:!1,level:"game",name:"file.game",formatter:options=>format("file",options.level,options.meta,options.message)}),new winston.transports.File({filename:`logs/Build-${buildNumber}/master.log`,json:!1,showLevel:!1,level:"server",name:"file.master",formatter:options=>format("file",options.level,options.meta,options.message)})];module.exports=(args=>{const transports=[];return args.includes("quiet")||transports.push(consoleTransports),args.includes("test")||(fs.existsSync("logs")||fs.mkdirSync("logs"),fs.existsSync(`logs/Build-${buildNumber}`)||fs.mkdirSync(`logs/Build-${buildNumber}`),fileTransports.forEach(transport=>transports.push(transport))),new winston.Logger({transports:transports,levels:{error:0,game:1,chat:2,server:2},colors:{error:"red",game:"green",chat:"white",server:"cyan"}})});